---
interface Props {
  game: any;
  showDeal?: boolean;
  dealDiscount?: number;
  dealPrice?: number;
  dealStore?: string;
  isHistoricalLow?: boolean;
}

const {
  game,
  showDeal = false,
  dealDiscount = 0,
  dealPrice = 0,
  dealStore = "",
  isHistoricalLow = false,
} = Astro.props;

// Inline helper function
function getDeckBadgeColor(status: string): string {
  const colors: Record<string, string> = {
    verified: "badge-verified",
    playable: "badge-playable",
    unsupported: "badge-unsupported",
    unknown: "bg-zinc-800 text-zinc-400",
  };
  return colors[status] || colors.unknown;
}

// Get rarity class based on discount
function getRarityClass(discount: number): string {
  if (discount >= 60) return "deal-card-legendary";
  if (discount >= 40) return "deal-card-epic";
  if (discount >= 20) return "deal-card-rare";
  return "deal-card-common";
}

const rarityClass = showDeal ? getRarityClass(dealDiscount) : "";
---

<a
  href={`/game/${game.slug}`}
  class="block"
  data-game-id={game.id}
  data-game-slug={game.slug}
  data-tracking="game-card-click"
>
  <article class={`deal-card ${rarityClass} group cursor-pointer`}>
    <!-- Game Cover -->
    <div
      class="aspect-[3/4] bg-zinc-800 rounded-lg overflow-hidden mb-3 relative"
    >
      {
        game.cover_image_url ? (
          <img
            src={game.cover_image_url}
            alt={game.title}
            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
          />
        ) : (
          <div class="w-full h-full flex items-center justify-center text-4xl">
            üéÆ
          </div>
        )
      }

      <!-- Historical Low Badge (top-left) -->
      {
        isHistoricalLow && (
          <div class="absolute top-2 left-2 bg-green-600 text-white px-2 py-1 rounded text-xs font-bold shadow-lg">
            üíé Historical Low
          </div>
        )
      }
    </div>

    <!-- Game Title -->
    <h3
      class="font-semibold text-zinc-50 mb-2 line-clamp-2 group-hover:text-blue-400 transition-colors"
    >
      {game.title}
    </h3>

    <!-- Badges -->
    <div class="flex flex-wrap gap-2 mb-3">
      <!-- Deck Status -->
      <span class={`badge ${getDeckBadgeColor(game.deck_status)}`}>
        {game.deck_status === "verified" && "‚úì Verified"}
        {game.deck_status === "playable" && "‚ö† Playable"}
        {game.deck_status === "unsupported" && "‚úó Unsupported"}
        {game.deck_status === "unknown" && "? Unknown"}
      </span>

      <!-- Controller Support -->
      {
        game.controller_support === "full" && (
          <span class="badge bg-blue-900/50 text-blue-400">
            üéÆ Full Controller
          </span>
        )
      }

      <!-- Battery Life -->
      <span class="badge bg-zinc-800 text-zinc-400 font-mono text-xs">
        üîã {game.battery_drain}
      </span>

      <!-- WARNING: Launcher -->
      {
        game.launcher && game.launcher !== "steam" && (
          <span
            class="badge bg-yellow-900/50 text-yellow-400 border border-yellow-800 text-xs"
            title={`Requires ${game.launcher.toUpperCase()} launcher`}
          >
            ‚ö†Ô∏è {game.launcher.toUpperCase()}
          </span>
        )
      }

      <!-- WARNING: Always Online -->
      {
        game.always_online && (
          <span
            class="badge bg-red-900/50 text-red-400 border border-red-800 text-xs"
            title="Requires internet connection"
          >
            ‚ö†Ô∏è Online
          </span>
        )
      }

      <!-- WARNING: Small Text -->
      {
        game.small_text_warning && (
          <span
            class="badge bg-orange-900/50 text-orange-400 border border-orange-800 text-xs"
            title="Small UI text on 7 inch screen"
          >
            ‚ö†Ô∏è Small Text
          </span>
        )
      }

      <!-- WARNING: Anti-cheat -->
      {
        game.anti_cheat_issues && (
          <span
            class="badge bg-red-900/50 text-red-400 border border-red-800 text-xs"
            title="Anti-cheat may cause issues"
          >
            ‚ö†Ô∏è Anti-cheat
          </span>
        )
      }
    </div>

    <!-- Deal Info (if showing deal) -->
    {
      showDeal && (
        <div class="pt-3 border-t border-zinc-800 space-y-1">
          <div class="flex items-center justify-between">
            <span class="text-2xl font-bold text-zinc-50 font-mono">
              ${Number(dealPrice).toFixed(2)}
            </span>
            <span class="text-lg font-bold text-deck-orange font-mono">
              -{dealDiscount}%
            </span>
          </div>
          {dealStore && (
            <p class="text-xs text-zinc-500">
              on {dealStore.charAt(0).toUpperCase() + dealStore.slice(1)}
            </p>
          )}
        </div>
      )
    }

    <!-- Stats -->
    <div class="flex gap-2 text-xs text-zinc-500 mt-2">
      {game.metacritic_score && <span>MC: {game.metacritic_score}</span>}
      {
        game.steam_positive_percent && (
          <span>üëç {game.steam_positive_percent}%</span>
        )
      }
    </div>
  </article>
</a>
