---
import Badge from "./Badge.astro";
import { getDeviceName } from "../lib/helpers";

interface Props {
  deal: any;
  device?: string;
}

const { deal, device = "steam_deck" } = Astro.props;
const game = deal.game_id;
const deviceName = getDeviceName(device);

// Device-specific performance data
function getDevicePerformance(game: any, device: string) {
  const perfData = game.device_performance?.[device];
  if (!perfData) return null;

  return {
    fps: perfData.fps_avg,
    battery: perfData.battery_hours,
    status: perfData.status,
    estimated: perfData.estimated,
  };
}

const perf = getDevicePerformance(game, device);

// Curator storytelling points
const storyPoints: { icon: string; text: string; type: string }[] = [];

if (perf?.status === "excellent") {
  storyPoints.push({
    icon: "‚ö°",
    text: `Runs excellently on ${deviceName}`,
    type: "positive",
  });
}

if (perf?.fps && perf.fps >= 60) {
  storyPoints.push({
    icon: "üéØ",
    text: `Smooth ${perf.fps} FPS${perf.estimated ? " (estimated)" : ""}`,
    type: "positive",
  });
}

if (perf?.battery && perf.battery >= 5) {
  storyPoints.push({
    icon: "üîã",
    text: `${perf.battery}h battery ‚Äì marathon sessions`,
    type: "positive",
  });
}

if (game.controller_support === "full") {
  storyPoints.push({
    icon: "üéÆ",
    text: "Perfect controller support",
    type: "positive",
  });
}

if (game.offline_playable) {
  storyPoints.push({
    icon: "‚úàÔ∏è",
    text: "Works offline ‚Äì perfect for travel",
    type: "positive",
  });
}

if (game.launcher && game.launcher !== "steam") {
  storyPoints.push({
    icon: "‚ö†Ô∏è",
    text: `Requires ${game.launcher.toUpperCase()} launcher`,
    type: "warning",
  });
}

if (game.small_text_warning) {
  storyPoints.push({
    icon: "‚ö†Ô∏è",
    text: `Small UI text on ${deviceName}`,
    type: "warning",
  });
}

if (storyPoints.length === 0) {
  storyPoints.push({
    icon: "üíé",
    text: "Great deal on a quality game",
    type: "positive",
  });
}

// Smart urgency timer (only show < 72h)
function getSmartTimer(expiresAt: string | null) {
  if (!expiresAt) return null;

  const diff = new Date(expiresAt).getTime() - Date.now();
  if (diff <= 0) return { text: "EXPIRED", type: "expired" };

  const hoursLeft = Math.floor(diff / 36e5);

  // > 72h: "Limited time deal" (low urgency)
  if (hoursLeft > 72) {
    return { text: "Limited time deal", type: "low" };
  }

  // < 72h but > 24h: "X days left" (medium urgency)
  const daysLeft = Math.floor(hoursLeft / 24);
  if (daysLeft > 1) {
    return { text: `${daysLeft} days left`, type: "medium" };
  }

  // < 24h but > 1h: "X hours left" (high urgency)
  if (hoursLeft > 1) {
    return { text: `${hoursLeft} hours left`, type: "high" };
  }

  // < 1h: "ENDING SOON!" (critical)
  return { text: "ENDING SOON!", type: "critical" };
}

const timer = getSmartTimer(deal.expires_at);
---

<article class="relative">
  <div
    class="absolute inset-0 bg-gradient-to-br from-blue-600/10 via-transparent to-purple-600/10 rounded-2xl blur-xl"
  >
  </div>

  <div
    class="relative bg-zinc-900/80 backdrop-blur-sm border border-zinc-800 rounded-2xl overflow-hidden"
  >
    <!-- Header -->
    <div
      class="bg-gradient-to-r from-zinc-900 to-zinc-800 px-6 py-4 border-b border-zinc-700"
    >
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="flex items-center gap-3">
          <Badge variant="featured" size="lg" icon="üéØ">
            DEAL OF THE DAY
          </Badge>

          {
            deal.is_historical_low && (
              <Badge variant="historical_low" size="sm" icon="üíé">
                ALL-TIME LOW
              </Badge>
            )
          }
        </div>

        {
          timer && timer.type === "low" && (
            <Badge variant="timer_low" size="sm" icon="‚è±">
              {timer.text}
            </Badge>
          )
        }
        {
          timer && timer.type === "medium" && (
            <Badge variant="timer_medium" size="sm" icon="‚è±">
              {timer.text}
            </Badge>
          )
        }
        {
          timer && timer.type === "high" && (
            <Badge variant="timer_high" size="sm" icon="‚è±">
              {timer.text}
            </Badge>
          )
        }
        {
          timer && timer.type === "critical" && (
            <Badge variant="timer_critical" size="sm" icon="‚è±">
              {timer.text}
            </Badge>
          )
        }
      </div>
    </div>

    <!-- Content -->
    <div class="grid md:grid-cols-[280px_1fr] gap-8 p-6 md:p-8">
      <!-- Cover -->
      <div class="relative">
        <div
          class="aspect-[3/4] rounded-xl overflow-hidden bg-zinc-800 shadow-2xl group"
        >
          {
            game.cover_image_url ? (
              <img
                src={game.cover_image_url}
                alt={game.title}
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
              />
            ) : (
              <div class="w-full h-full flex items-center justify-center text-6xl">
                üéÆ
              </div>
            )
          }

          <!-- Discount Badge (custom positioned) -->
          <div class="absolute -top-2 -right-2 rotate-3">
            <Badge variant="discount_large" size="xl">
              -{deal.discount_percent}%
            </Badge>
          </div>
        </div>
      </div>

      <!-- Info -->
      <div class="space-y-6">
        <div>
          <h2 class="text-4xl md:text-5xl font-bold text-white mb-2">
            {game.title}
          </h2>
          <!-- FIX 1: Device-aware copy (already implemented) -->
          <p class="text-zinc-400 text-sm">
            {
              device === "all"
                ? "Compatible with all handheld PCs"
                : `Verified on ${deviceName}`
            }
          </p>
        </div>

        {
          perf && (
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              {perf.fps && (
                <div class="bg-zinc-800/50 border border-zinc-700 rounded-lg px-4 py-3">
                  <div class="text-xs text-zinc-400">Performance</div>
                  <div class="text-2xl font-bold">{perf.fps} FPS</div>
                </div>
              )}
              {perf.battery && (
                <div class="bg-zinc-800/50 border border-zinc-700 rounded-lg px-4 py-3">
                  <div class="text-xs text-zinc-400">Battery</div>
                  <div class="text-2xl font-bold">{perf.battery}h</div>
                </div>
              )}
              {perf.status && (
                <div class="bg-zinc-800/50 border border-zinc-700 rounded-lg px-4 py-3">
                  <div class="text-xs text-zinc-400">Status</div>
                  <div class="text-sm font-semibold capitalize text-green-400">
                    {perf.status}
                  </div>
                </div>
              )}
            </div>
          )
        }

        <!-- Story -->
        <div class="bg-zinc-800/30 border border-zinc-700/50 rounded-xl p-5">
          <h3 class="text-sm font-bold text-zinc-300 mb-3">
            ‚úçÔ∏è Why This Works on {deviceName}
          </h3>
          <ul class="space-y-2">
            {
              storyPoints.slice(0, 5).map((p) => (
                <li class="flex gap-3 text-sm">
                  <span>{p.icon}</span>
                  <span
                    class={
                      p.type === "warning" ? "text-orange-300" : "text-zinc-300"
                    }
                  >
                    {p.text}
                  </span>
                </li>
              ))
            }
          </ul>
        </div>

        <!-- Price + CTA -->
        <div class="space-y-4">
          <div class="flex items-baseline gap-3">
            <span class="text-sm text-zinc-500 line-through">
              ${Number(deal.normal_price).toFixed(2)}
            </span>
            <span class="text-4xl font-black">
              ${Number(deal.price).toFixed(2)}
            </span>
            <span class="text-xl font-bold text-green-400">
              Save ${
                (Number(deal.normal_price) - Number(deal.price)).toFixed(2)
              }
            </span>
          </div>

          <a
            href={deal.url}
            target="_blank"
            rel="noopener noreferrer"
            data-game-id={game.id}
            data-deal-id={deal.id}
            data-store={deal.store}
            class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center font-bold py-4 rounded-xl transition-all hover:scale-[1.02] shadow-lg shadow-blue-900/50"
          >
            Get Deal on {
              deal.store.charAt(0).toUpperCase() + deal.store.slice(1)
            } ‚Üí
          </a>
        </div>

        <!-- Social Proof -->
        <div class="flex gap-4 text-xs text-zinc-400">
          {
            game.steam_positive_percent && (
              <span>
                üëç <b class="text-green-400">{game.steam_positive_percent}%</b>{" "}
                positive
              </span>
            )
          }
          {
            game.metacritic_score && (
              <span>
                üìä <b>{game.metacritic_score}</b> Metacritic
              </span>
            )
          }
        </div>
      </div>
    </div>
  </div>
</article>
