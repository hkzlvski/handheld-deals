---
import Layout from "../layouts/Layout.astro";
import MissionStats from "../components/MissionStats.astro";
import GameCard from "../components/GameCard.astro";
import DealOfTheDay from "../components/DealOfTheDay.astro";
import EmptyState from "../components/EmptyState.astro";

import {
  getDealOfTheDay,
  getDeckVerifiedDeals,
  getBatterySaverDeals,
  getTopDiscountDeals,
  getMissionStats,
} from "../lib/api";

// Fetch all data
const [dealOfDay, verifiedDeals, batterySavers, topDiscounts, missionStats] =
  await Promise.all([
    getDealOfTheDay(),
    getDeckVerifiedDeals(12),
    getBatterySaverDeals(12),
    getTopDiscountDeals(12),
    getMissionStats(),
  ]);
---

<Layout title="Handheld Deals - Best Gaming Deals">
  <main class="flex-1">
    <!-- Hero Section -->
    <section
      class="bg-gradient-to-b from-zinc-900 to-zinc-950 border-b border-zinc-800"
    >
      <div class="container mx-auto px-4 py-16">
        <h1 class="text-6xl md:text-7xl font-bold mb-4">ðŸŽ® Handheld Deals</h1>
        <p class="text-xl text-zinc-300 mb-8 max-w-2xl">
          Find the best game deals for Steam Deck, ROG Ally, and handheld gaming
          PCs with verified compatibility.
        </p>

        <!-- Mission Stats -->
        <MissionStats
          activeDeals={missionStats.activeDeals}
          newVerified={missionStats.newVerified}
          potentialSavings={missionStats.potentialSavings}
        />
      </div>
    </section>

    <!-- Deal of the Day -->
    {
      dealOfDay && dealOfDay.game_id && (
        <section class="container mx-auto px-4 py-16">
          <DealOfTheDay deal={dealOfDay} />
        </section>
      )
    }

    <!-- Active Missions -->
    <section class="container mx-auto px-4 py-16">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-4xl font-bold">ðŸŽ¯ ACTIVE MISSIONS</h2>
          <p class="text-sm text-zinc-400 mt-1">Verified deals ending soon</p>
        </div>
        <a
          href="/browse?filter=verified"
          class="inline-flex items-center gap-1 px-3 py-1.5 border border-blue-600 text-blue-400 hover:bg-blue-600/10 rounded-lg text-sm font-medium transition-colors"
        >
          View All â†’
        </a>
      </div>
      {
        verifiedDeals.length > 0 ? (
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
            {verifiedDeals.map(
              (deal: any) =>
                deal.game_id && (
                  <GameCard
                    game={deal.game_id}
                    showDeal={true}
                    dealDiscount={deal.discount_percent}
                    dealPrice={deal.price}
                    dealStore={deal.store}
                    isHistoricalLow={deal.is_historical_low}
                  />
                ),
            )}
          </div>
        ) : (
          <EmptyState
            title="No featured deals right now"
            message="Check back soon for verified Steam Deck deals!"
          />
        )
      }
    </section>

    <!-- Long-Haul Ops -->
    {
      batterySavers.length > 0 && (
        <section class="bg-zinc-900/30 border-y border-zinc-800">
          <div class="container mx-auto px-4 py-16">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="text-4xl font-bold">ðŸ”‹ LONG-HAUL OPS</h2>
                <p class="text-sm text-zinc-400 mt-1">
                  Marathon sessions, minimal charging
                </p>
              </div>
              <a
                href="/browse?filter=battery-savers"
                class="inline-flex items-center gap-1 px-3 py-1.5 border border-blue-600 text-blue-400 hover:bg-blue-600/10 rounded-lg text-sm font-medium transition-colors"
              >
                View All â†’
              </a>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
              {batterySavers.map(
                (deal: any) =>
                  deal.game_id && (
                    <GameCard
                      game={deal.game_id}
                      showDeal={true}
                      dealDiscount={deal.discount_percent}
                      dealPrice={deal.price}
                      dealStore={deal.store}
                      isHistoricalLow={deal.is_historical_low}
                    />
                  ),
              )}
            </div>
          </div>
        </section>
      )
    }

    <!-- Legendary Loot -->
    <section class="container mx-auto px-4 py-16">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-4xl font-bold">ðŸ’° LEGENDARY LOOT</h2>
          <p class="text-sm text-zinc-400 mt-1">Epic deals, some trade-offs</p>
        </div>
        <a
          href="/browse?filter=top-discounts"
          class="inline-flex items-center gap-1 px-3 py-1.5 border border-blue-600 text-blue-400 hover:bg-blue-600/10 rounded-lg text-sm font-medium transition-colors"
        >
          View All â†’
        </a>
      </div>
      {
        topDiscounts.length > 0 ? (
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
            {topDiscounts.map(
              (deal: any) =>
                deal.game_id && (
                  <GameCard
                    game={deal.game_id}
                    showDeal={true}
                    dealDiscount={deal.discount_percent}
                    dealPrice={deal.price}
                    dealStore={deal.store}
                    isHistoricalLow={deal.is_historical_low}
                  />
                ),
            )}
          </div>
        ) : (
          <EmptyState
            title="No big discounts available"
            message="Deals refresh daily - check back tomorrow!"
          />
        )
      }
    </section>
  </main>
</Layout>
