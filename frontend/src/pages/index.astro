---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import Hero from "../components/Hero.astro";
import MissionStats from "../components/MissionStats.astro";
import GameCard from "../components/GameCard.astro";
import DealOfTheDay from "../components/DealOfTheDay.astro";
import CuratorPicks from "../components/CuratorPicks.astro";
import SocialProof from "../components/SocialProof.astro";
import BatteryChampions from "../components/BatteryChampions.astro";
import NewsletterCTA from "../components/NewsletterCTA.astro";
import TopDiscounts from "../components/TopDiscounts.astro";
import EmptyState from "../components/EmptyState.astro";

import {
  getDealOfTheDay,
  getWeeklyGems,
  getDeckVerifiedDeals,
  getBatterySaverDeals,
  getTopDiscountDeals,
  getMissionStats,
} from "../lib/api";

const selectedDevice = Astro.locals.device || "all";

const [
  dealOfDay,
  weeklyGems,
  verifiedDeals,
  batterySavers,
  topDiscounts,
  missionStats,
] = await Promise.all([
  getDealOfTheDay(selectedDevice),
  getWeeklyGems(5),
  getDeckVerifiedDeals(12, selectedDevice),
  getBatterySaverDeals(12, selectedDevice),
  getTopDiscountDeals(12, selectedDevice),
  getMissionStats(),
]);

const deviceNames: Record<string, string> = {
  all: "All Devices",
  steam_deck: "Steam Deck",
  rog_ally: "ROG Ally",
  legion_go: "Legion GO",
};

const currentDeviceName = deviceNames[selectedDevice];
const isSpecificDevice = selectedDevice !== "all";

const pageTitle = isSpecificDevice
  ? `Handheld Deals - Best Gaming Deals for ${currentDeviceName}`
  : "Handheld Deals - Best Gaming Deals";

const sectionTitle = isSpecificDevice
  ? `‚≠ê ${currentDeviceName.toUpperCase()} EXCELLENCE`
  : "üéØ ACTIVE MISSIONS";

const sectionSubtitle = isSpecificDevice
  ? `Games running excellently on ${currentDeviceName}`
  : "Current best deals across devices";

const emptyTitle = isSpecificDevice
  ? `No ${currentDeviceName} deals right now`
  : "No featured deals right now";

const emptyMessage = isSpecificDevice
  ? 'Try selecting "All Devices" to see more deals, or check back soon!'
  : "Check back soon for verified Steam Deck deals!";

const verifiedUrl = isSpecificDevice
  ? `/browse?filter=verified&device=${selectedDevice}`
  : "/browse?filter=verified";
---

<Layout title={pageTitle}>
  <main class="flex-1">
    <!-- Hero -->
    <Hero device={selectedDevice} />

    <!-- Deal of the Day -->
    {
      dealOfDay && dealOfDay.game_id && (
        <section id="deal-of-the-day" class="container mx-auto px-4 py-12">
          <DealOfTheDay deal={dealOfDay} device={selectedDevice} />
        </section>
      )
    }

    <!-- Curator's Picks -->
    {
      weeklyGems?.length > 0 && (
        <CuratorPicks picks={weeklyGems} device={selectedDevice} />
      )
    }

    <!-- Social Proof -->
    <SocialProof device={selectedDevice} />

    <!-- Divider -->
    <div class="container mx-auto px-4">
      <div
        class="w-4/5 mx-auto border-t border-zinc-700/50 bg-gradient-to-r from-transparent via-zinc-700/50 to-transparent"
      >
      </div>
    </div>

    <!-- Active Missions -->
    <section id="weekly-gems" class="container mx-auto px-4 py-16">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-3xl font-bold">{sectionTitle}</h2>
          <p class="text-sm text-zinc-500 mt-1">{sectionSubtitle}</p>
        </div>

        <a
          href={verifiedUrl}
          class="inline-flex items-center gap-1 px-3 py-1.5 border border-blue-600 text-blue-400 hover:bg-blue-600/10 rounded-lg text-sm font-medium transition-colors"
        >
          View All ‚Üí
        </a>
      </div>

      {
        verifiedDeals.length > 0 ? (
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4">
            {verifiedDeals.map(
              (deal: any) =>
                deal.game_id && (
                  <GameCard
                    game={deal.game_id}
                    showDeal
                    dealDiscount={deal.discount_percent}
                    dealPrice={deal.price}
                    dealStore={deal.store}
                    isHistoricalLow={deal.is_historical_low}
                    dealExpiryDate={deal.expiry_date}
                  />
                ),
            )}
          </div>
        ) : (
          <EmptyState title={emptyTitle} message={emptyMessage} />
        )
      }
    </section>

    <!-- Battery Champions -->
    {
      batterySavers.length > 0 && (
        <BatteryChampions deals={batterySavers} device={selectedDevice} />
      )
    }

    <!-- Newsletter -->
    <NewsletterCTA device={selectedDevice} />

    <!-- Top Discounts -->
    {
      topDiscounts.length > 0 && (
        <TopDiscounts deals={topDiscounts} device={selectedDevice} />
      )
    }
  </main>
</Layout>
